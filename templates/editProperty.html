{% extends 'base.html' %}
{% block title %}Editar {{ property.name }} · Bienes Raíces Boutique{% endblock %}

{% block content %}
<section class="relative py-16">
    <div class="mx-auto max-w-6xl px-6">
        <div class="mb-10 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="animate-on-scroll">
                <span class="inline-flex items-center gap-2 rounded-full bg-amber-100 px-4 py-1 text-sm font-semibold text-amber-600"><i class="fa-solid fa-pen"></i> Edición de propiedad</span>
                <h1 class="section-title mt-4 text-3xl">Actualiza la información de {{ property.name }}</h1>
                <p class="mt-3 max-w-2xl text-sm text-slate-600">Realiza modificaciones precisas y mantené tu catálogo alineado con la experiencia visual del sitio. Guarda los cambios para verlos reflejados al instante.</p>
            </div>
            <a class="btn-secondary animate-on-scroll" href="{{ url_for('property_detail', property_id=property.id) }}"><i class="fa-solid fa-eye"></i> Ver vista pública</a>
        </div>

        <form action="{{ url_for('edit_property', property_id=property.id) }}" method="POST" enctype="multipart/form-data" class="glass-card space-y-6 p-8 text-slate-600 animate-on-scroll">
            <div class="grid gap-6 md:grid-cols-2">
                <div>
                    <label for="name" class="text-sm font-semibold text-slate-600">Nombre</label>
                    <input type="text" id="name" name="name" value="{{ property.name }}" class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" required />
                </div>
                <div>
                    <label for="location" class="text-sm font-semibold text-slate-600">Ubicación</label>
                    <input type="text" id="location" name="location" value="{{ property.location }}" class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" required />
                </div>
                <div>
                    <label for="price" class="text-sm font-semibold text-slate-600">Precio</label>
                    <input type="number" id="price" name="price" value="{{ property.price }}" class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" required />
                </div>
                <div>
                    <label for="main_image" class="text-sm font-semibold text-slate-600">Imagen principal</label>
                    <input type="file" id="main_image" name="main_image" class="mt-2 w-full cursor-pointer rounded-2xl border border-dashed border-slate-300 bg-white/70 px-4 py-3 text-sm text-slate-500 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" accept="image/*" />
                </div>
            </div>
            <div>
                <label for="description" class="text-sm font-semibold text-slate-600">Descripción</label>
                <textarea id="description" name="description" rows="4" class="mt-2 w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" required>{{ property.description }}</textarea>
            </div>
            <div class="space-y-4">
                <label class="text-sm font-semibold text-slate-600" for="repertory_images">Imágenes de repertorio</label>
                {% if property.repertory_images %}
                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        {% for image in property.repertory_images.split(',') %}
                            <div class="group relative overflow-hidden rounded-3xl bg-white/70 shadow-lg animate-on-scroll">
                                <img src="{{ url_for('static', filename=image.split('static/')[-1]) }}" alt="Imagen adicional de {{ property.name }}" class="h-48 w-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                <button type="button" class="absolute right-3 top-3 inline-flex items-center gap-2 rounded-full bg-rose-500/90 px-3 py-1 text-xs font-semibold text-white shadow-lg transition-transform hover:-translate-y-1" data-image="{{ image }}">
                                    <i class="fa-solid fa-trash"></i> Eliminar
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-slate-500">Aún no has agregado imágenes adicionales. Sube nuevas fotografías para enriquecer la galería.</p>
                {% endif %}
                <input type="file" id="repertory_images" name="repertory_images" multiple class="w-full cursor-pointer rounded-2xl border border-dashed border-slate-300 bg-white/70 px-4 py-3 text-sm text-slate-500 focus:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-100" accept="image/*" />
            </div>
            <div class="flex flex-wrap gap-3">
                <button type="submit" class="btn-primary"><i class="fa-solid fa-floppy-disk"></i> Guardar cambios</button>
                <a href="{{ url_for('property_detail', property_id=property.id) }}" class="btn-secondary"><i class="fa-solid fa-arrow-left"></i> Cancelar</a>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('button[data-image]').forEach((button) => {
        button.addEventListener('click', () => {
            const image = button.getAttribute('data-image');
            if (!image) return;
            if (!confirm('¿Deseas eliminar esta imagen de repertorio?')) return;

            fetch('{{ url_for('remove_repertory_image') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ocurrió un error al eliminar la imagen.');
                    }
                })
                .catch(() => alert('No se pudo eliminar la imagen en este momento.'));
        });
    });
</script>
{% endblock %}
